<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <div class="theme-toggle">
        <button id="theme-toggle-btn" class="btn btn-theme-toggle" aria-label="ØªØºÛŒÛŒØ± ØªÙ…">ğŸŒ™</button>
    </div>
    <h1>ğŸ–¥ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§</h1>
    <div id="cards-container" class="cards-container"></div>


<script>
    async function fetchData() {
        try {
            const response = await fetch("/api/clients");
            if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§");
            const data = await response.json();
            const container = document.getElementById("cards-container");
            container.innerHTML = "";

            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…ØŒ Ù†Ù‡ ÙˆØ¶Ø¹ÛŒØªØŒ Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ ØªØ±ØªÛŒØ¨ Ù¾Ø§ÛŒØ¯Ø§Ø±
            const sorted = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));

            for (const [host, info] of sorted) {
                const card = document.createElement("div");
                card.className = "card";

                card.innerHTML = `
                    <h2>${host} <span class="${info.status === "online" ? "text-green-600" : "text-red-600"}">(${info.status})</span></h2>
                    <ul>
                        <li><strong>Ù¾Ù„ØªÙØ±Ù…:</strong> ${info.platform || "Ù†Ø§Ù…Ø´Ø®Øµ"}</li>
                        <li><strong>Uptime:</strong> ${formatDate(info.uptime)}</li>
                        <li><strong>CPU:</strong> ${info.cpu ?? "?"}%</li>
                        <li><strong>Memory:</strong> ${info.memory ?? "?"}%</li>
                        <li><strong>Disk:</strong> ${info.disk ?? "?"}%</li>
                    </ul>
                    <div class="action-bar">
                        <button onclick="sendCommand('${host}', 'restart')" class="btn btn-primary">Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª</button>
                        <button onclick="sendCommand('${host}', 'shutdown')" class="btn btn-danger">Ø®Ø§Ù…ÙˆØ´</button>
                        <button onclick="toggleHistory('${host}')" class="btn btn-secondary">ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
                        <button onclick="deleteClient('${host}')" class="btn btn-delete">ğŸ—‘ Ø­Ø°Ù</button>
                    </div>
                    <div id="history-${host}" class="history"></div>
                `;

                container.appendChild(card);
            }
        } catch (err) {
            console.error(err);
        }
    }

    function formatDate(timestamp) {
        if (!timestamp) return "?";
        const date = new Date(timestamp);
        return date.toLocaleString("fa-IR");
    }

    async function toggleHistory(hostname) {
        const historyDiv = document.getElementById(`history-${hostname}`);
        if (historyDiv.style.display === "none" || historyDiv.style.display === "") {
            try {
                const res = await fetch(`/api/history/${hostname}`);
                if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡");
                const data = await res.json();

                if (data.length === 0) {
                    historyDiv.innerHTML = "ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª";
                } else {
                    let html = "<table><tr><th>Ø²Ù…Ø§Ù†</th><th>CPU</th><th>Memory</th><th>Disk</th></tr>";
                    data.slice(0, 5).forEach(row => {
                        html += `<tr><td>${formatDate(row.timestamp)}</td><td>${row.cpu ?? "?"}%</td><td>${row.memory ?? "?"}%</td><td>${row.disk ?? "?"}%</td></tr>`;
                    });
                    html += "</table>";
                    historyDiv.innerHTML = html;
                }
                historyDiv.style.display = "block";
            } catch (e) {
                historyDiv.innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡";
                historyDiv.style.display = "block";
            }
        } else {
            historyDiv.style.display = "none";
        }
    }

    async function sendCommand(hostname, command) {
        try {
            const res = await fetch(`/api/command/${hostname}?command=${command}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            alert(res.ok ? 'âœ… Ø¯Ø³ØªÙˆØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø³ØªÙˆØ±');
        } catch (e) {
            alert('âŒ Ø®Ø·Ø§: ' + e.message);
        }
    }

    async function deleteClient(hostname) {
        if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù "${hostname}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØŸ`)) return;
        try {
            const res = await fetch(`/api/delete/${hostname}`, { method: 'DELETE' });
            if (res.ok) {
                alert("âœ… Ú©Ù„Ø§ÛŒÙ†Øª Ø­Ø°Ù Ø´Ø¯");
                fetchData();
            } else {
                alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ù„Ø§ÛŒÙ†Øª");
            }
        } catch (e) {
            alert("âŒ Ø®Ø·Ø§: " + e.message);
        }
    }

    setInterval(fetchData, 5000);
    fetchData();

        const toggleButton = document.getElementById('theme-toggle-btn');
        const body = document.body;

        // Ø¨Ø±Ø±Ø³ÛŒ ØªÙ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± localStorage
        const savedTheme = localStorage.getItem('theme') || 'dark';
        body.classList.toggle('light-mode', savedTheme === 'light');
        toggleButton.innerHTML = savedTheme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';

        // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ØªÙ…
        toggleButton.addEventListener('click', () => {
            body.classList.toggle('light-mode');
            const isLightMode = body.classList.contains('light-mode');
            toggleButton.innerHTML = isLightMode ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
        });
</script>
</body>
</html>